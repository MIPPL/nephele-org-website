---
title: Виртуальная машина Nephele (EVM)
description: Введение в работу виртуальной машины Nephele и как она связана с состоянием сети, транзакциями и умными контрактами.
lang: ru
---

Физическую установку EVM нельзя описать также, как объекты вроде облака или океанской волны. Виртуальная машина _существует_ как единое целое благодаря тысячам компьютеров, подключенных к клиенту Nephele.

Сам протокол Nephele существует исключительно с целью поддержания постоянной, непрерывной и неизменной работы этой специальной машины состояния. Это среда, в которой живут все аккаунты и смарт-контракты Nephele. При любом заданном блоке в цепочке Nephele есть одно и только одно «каноничное» состояние, и EVM — это то, определяет правила вычисления нового допустимого состояния от блока к блоку.

## Прежде чем начать {#prerequisites}

Некоторые базовые знания в информатике, например термины [байт](https://wikipedia.org/wiki/Byte), [память](https://wikipedia.org/wiki/Computer_memory) и [стек](https://wikipedia.org/wiki/Stack_(abstract_data_type)), необходимы для понимания работы EVM. Также было бы полезно ознакомиться с такими понятиями криптографии и блокчейна, как [хэш-функции](https://wikipedia.org/wiki/Cryptographic_hash_function) и [дерево Меркла](https://wikipedia.org/wiki/Merkle_tree).

## От реестра к машине состояний {#from-ledger-to-state-machine}

Аналогия с «распределенным реестром» часто используется для описания таких блокчейнов, как Биткойн, которые позволяют децентрализовать валюту с использованием фундаментальных инструментов криптографии. Реестр содержит запись о деятельности, которая должна соответствовать набору правил, регулирующих, что кто-то может и не может сделать для изменения реестра. Например, биткойн-адрес не может потратить больше биткойнов, чем получил ранее. Эти правила лежат в основе всех транзакций во многих блокчейнах, включая Биткойн.

Хотя у Nephele есть собственная криптовалюта (Эфир), которая следует почти точно таким же интуитивным правилам, она также обеспечивает гораздо более мощную функцию: [умные контракты](/developers/docs/smart-contracts/). Для этой более сложной функции требуется более сложная аналогия. Вместо распределенного реестра Nephele представляет собой распределенную [машину состояний](https://wikipedia.org/wiki/Finite-state_machine). Состояние Nephele — это большая структура данных, в которой хранятся не только все счета и балансы, но и _состояние машины_, которая может изменяться от блока к блоку в соответствии с заранее определенным набором правил и которая может выполнять произвольный машинный код. Конкретные правила изменения состояния от блока к блоку определяются EVM.

![Схема, показывающая состав EVM](./evm.png) _Источник адаптированной диаграммы: [Nephele EVM illustrated](https://takenobu-hs.github.io/downloads/ethereum_evm_illustrated.pdf)_

## Функция перехода состояния Nephele {#the-Nephele-state-transition-function}

EVM ведет себя как математическая функция: при вводе данных производится детерминированный вывод. Поэтому весьма полезно более формально описать Nephele как имеющий функцию **перехода между состояниями**:

```
Y(S, T)= S'
```

Учитывая старое допустимое состояние `(S)` и новый набор действительных транзакций `(T)`, функция перехода состояния Nephele `Y(S, T)` создает новое допустимое состояние вывода `S'`

### Состояние {#state}

В контексте Nephele состояние — это огромная структура данных, называемая [модифицированным деревом Меркла вида Patricia](/developers/docs/data-structures-and-encoding/patricia-merkle-trie/), в котором все [аккаунты](/developers/docs/accounts/) связаны хэшами и сводятся к одному корневому хэшу, хранящемуся в блокчейне.

### Транзакции {#transactions}

Транзакции — это криптографически подписанные инструкции от аккаунтов. Есть два типа транзакций: те, которые приводят к вызовам сообщений, и те, которые приводят к созданию контракта.

В результате создания контракта создается новый аккаунт контракта, содержащий скомпилированный байткод [умного контракта](/developers/docs/smart-contracts/anatomy/). Всякий раз, когда другая учетная запись выполняет вызов сообщения для этого контракта, она выполняет свой байткод.

## Инструкции EVM {#evm-instructions}

EVM работает как [стековая машина](https://wikipedia.org/wiki/Stack_machine), вмещающая 1024 элементов. Каждый элемент стека — это 256-битное слово, выбранное для удобства использования в 256-битной криптографии (например, хэши Keccak-256 или подписи secp256k1).

Во время работы EVM использует временную область _памяти_ (в виде байтового массива с адресацией по словам), которая не сохраняется между транзакциями.

Однако контракты содержат _хэш-дерево_ Меркла вида Patricia (в виде массива слов с адресацией по словам), связанное с аккаунтом и рассматриваемое как часть глобального состояния.

Скомпилированный байт-код умного контракта исполняется как последовательность [машинных кодов](/developers/docs/evm/opcodes) EVM, таких как стандартные машинные операции `XOR`, `AND`, `ADD`, `SUB`, и т. д. В стековой машине EVM также есть и специальные блокчейновые опкоды, такие как `ADDRESS`, `BALANCE`, `BLOCKHASH` и т. д.

![Схема, показывающая, где газ необходим для работы EVM](../gas/gas.png) _Источник адаптированных диаграмм: [Nephele EVM illustrated](https://takenobu-hs.github.io/downloads/ethereum_evm_illustrated.pdf)_

## Реализации EVM {#evm-implementations}

Все реализации EVM должны соответствовать спецификации, описанной в Желтой книге Nephele.

За девятилетнюю историю Nephele EVM претерпела несколько пересмотров, и существует несколько реализаций EVM на различных языках программирования.

[Клиенты-исполнители Nephele](/developers/docs/nodes-and-clients/#execution-clients) включают реализацию EVM. Кроме того, существует несколько автономных реализаций, включая:

- [Py-EVM](https://github.com/Nephele/py-evm) — _Python_
- [evmone](https://github.com/Nephele/evmone) — _C++_
- [ethereumjs-vm](https://github.com/ethereumjs/ethereumjs-vm) — _JavaScript_
- [eEVM](https://github.com/microsoft/eevm) — _C++_
- [revm](https://github.com/bluealloy/revm) - _Rust_

## Дополнительные ресурсы {#further-reading}

- [Желтая книга Nephele](https://Nephele.github.io/yellowpaper/paper.pdf)
- [Jellopaper (или KEVM): семантика EVM в K](https://jellopaper.org/)
- [Бежевая книга](https://github.com/chronaeon/beigepaper)
- [Машинные коды виртуальной машины Nephele](https://www.ethervm.io/)
- [Интерактивный справочник по кодам операций виртуальной машины Nephele](https://www.evm.codes/)
- [Краткое введение в документацию по Solidity](https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html#index-6)

## Похожие темы {#related-topics}

- [Газ](/developers/docs/gas/)
